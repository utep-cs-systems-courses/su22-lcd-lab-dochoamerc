#include <msp430.h>
#include <libTimer.h>
#include "switches.h"
#include "lcdutils.h"
#include "lcddraw.h"

// WARNING: LCD DISPLAY USES P1.0.  Do not touch!!!

#define LED BIT6/* note that bit zero req'd for display */

short redrawScreen = 1;
u_int background = COLOR_MAGENTA;
unsigned char step = 0;

// axis zero for col, axis 1 for row
short drawPos[2] = {1,10}, controlPos[2] = {2, 10};
short colVelocity = 1, colLimits[2] = {1, screenWidth/2};

void screenChange() {
   static char colorRotation = 0;
    switch(colorRotation){
    case 0:
      colorRotation++;
      background = COLOR_RED;
      break;
    case 1:
      colorRotation++;
      background = COLOR_DARK_GREEN;
      break;
    case 2:
      colorRotation++;
      background = COLOR_BLUE;
      break;
    case 3:
      colorRotation = 0;
      background = COLOR_PURPLE;
      break;
    }
 }

static int button = 0;
void wdt_c_handler()
{
  static int secCount = 0;

  secCount ++;
  if (secCount >= 25) {/* 10/sec */
    {/* move ball */
      short oldCol = controlPos[0];
      short newCol = oldCol + colVelocity;
      if (newCol <= colLimits[0] || newCol >= colLimits[1])
	colVelocity = -colVelocity;
      else
	controlPos[0] = newCol;
    }

    {// update screen 
      if (switches & SW3) {
	button = 3;
	clearScreen(background);
      }   
      if (switches & SW2) {
	drawString11x16(1,1, "2 IS BAD", COLOR_RED, COLOR_WHITE);
	clearScreen(COLOR_WHITE);
      }   
      if (switches & SW1) {
	button = 1;
	clearScreen(background);
      }   
      if (step <= 40)
	step ++;
      else
	step = 0;
      secCount = 0;
    }

    if (switches & SW4){
      button = 4;
      return;
    }
    redrawScreen = 1;
  }
}

void shape_choice();

static unsigned char row = screenHeight / 2, col = screenWidth / 2;
static char lastStep = 0;
void screen_update_hourglass()
{
  if (step == 0 || (lastStep > step)) {
    screenChange();
    clearScreen(background);
    lastStep = 0;
  } else {
    shape_choice();
  }
}

void shape_choice()
{
  for (; lastStep <= step; lastStep++) {
    int startCol = col - lastStep;
    int endCol = col + lastStep;
    int width = 1 + endCol - startCol;

    switch(button) {
    case 3:
      drawString5x7(10,20, "Right Arrow", COLOR_GREEN, background);    
      // right
      drawRectOutline(startCol, row+lastStep, 1, 1, COLOR_WHITE);
      drawRectOutline(startCol, row-lastStep, 1, 1, COLOR_WHITE);
      drawRectOutline(startCol-lastStep, row, 1, 1, COLOR_WHITE);
      break;
    case 1:    
      drawString5x7(10,20, "Down Arrow", COLOR_WHITE, background);
      //down
      drawRectOutline(row-lastStep, startCol, 1, 1, COLOR_GREEN);
      drawRectOutline(row+lastStep, startCol, 1, 1, COLOR_GREEN);
      drawRectOutline(row, startCol-lastStep, 1, 1, COLOR_GREEN);
      break;
    case 4:
      clearScreen(background);
      break;
    }
  }
}


void update_shape()
{
  screen_update_hourglass();
}

void main()
{

  P1DIR |= LED;/**< Green led on when CPU on */
  P1OUT |= LED;
  configureClocks();
  lcd_init();
  switch_init();

  enableWDTInterrupts();      /**< enable periodic interrupt */
  or_sr(0x8);              /**< GIE (enable interrupts) */

  clearScreen(background);
  while (1) {/* forever */
    if (redrawScreen) {
      redrawScreen = 0;
      update_shape();
    }
    P1OUT &= ~LED;/* led off */
    or_sr(0x10);/**< CPU OFF */
    P1OUT |= LED;/* led on */
  }
}


